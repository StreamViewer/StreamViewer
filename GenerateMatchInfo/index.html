<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

    <link href="../styles/main.css" rel="stylesheet" />
    <script src="../scripts/jspdf/jspdf.js"></script>
    <script src="../scripts/jspdf/FileSaver.js"></script>

    <style>
        #content {
            overflow-y: scroll;
        }

        #h2h, #outright {
            display: none;
            padding: 10px;
        }

        #add-note {
            position: fixed;
            background-color: #282828;
            border: solid 1px #404040;
            border-left: none;
            top: 145px;
            left: 70px;
            height: 80px;
            width: 200px;
            z-index: 2;
            text-align: center;
            line-height: 40px;
            display: none;
        }

        #add-note input[type='text'] {
            width: 100%;
            box-sizing: border-box;
        }

        .info-area {
            position: relative;
            padding: 10px;
            margin: 10px;
            border: solid 6px #404040;
            border-radius: 10px;
            width: 520px;
            line-height: 40px;
        }

        .remove-item {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 40px;
            height: 40px;
        }

        .count {
            width: 50px;
        }
    </style>

    <script>
        loadTeams();

        function loadTeams() {
            var req = new XMLHttpRequest();

            req.onreadystatechange = function(res) {
                if (req.readyState == 4) {
                    if (req.status == 200) {
                        var d = document.getElementById('team-list');

                        var list = parseTeamCSV(req.responseText);

                        list.forEach(function(t) {
                            var o = document.createElement('option');
                            o.value = t;
                            d.appendChild(o);
                        });
                    }
                }
            };

            req.open('GET', 'teams.csv', true);

            req.send();
        }

        function parseTeamCSV(text) {
            var data = text.split('\n');
            var ret = [];

            var i = data.length;
            while (i--) {
                ret.push(data[i].split(',')[2]);
            }

            return ret;
        }
    </script>
    <!--<script>
        var app = {};

        loadTeams();

        function loadTeams() {
            var req = new XMLHttpRequest();

            req.onreadystatechange = function(res) {
                console.log(req.status);
                if (req.readyState == 4) {
                    console.log(req.status);

                    if (req.status == 200) {
                        app.teams = JSON.parse(req.responseText);

                        var d = document.getElementById('team-list');

                        app.teams.forEach(function(t) {
                            var o = document.createElement('option');
                            o.value = t.name;
                            d.appendChild(o);
                        })
                    }
                }
            };

            req.open('GET', 'https://unikrn.com/rest/teams', true);

            req.send();
        }
    </script>-->
</head>
<body>
<div id="side-menu">
    <a class="material-icons" href="../" title="Home">&#xE88A;</a>
    <!-- not for now <a class="material-icons" href="#" title="Apps">&#xE5C3;</a> -->
    <hr />
    <a class="material-icons" href="#" onclick="addItem()" title="Add Item">&#xE145;</a>
    <a class="material-icons" href="#" onclick="toggleNoteContainer()" title="Add Note">&#xE89C;</a>
    <hr />
    <a class="material-icons" href="#" onclick="generate()" title="Generate">&#xE2C4;</a>

    <!-- <a class="material-icons settings-button" href="#" title="Settings">&#xE8B8;</a>
    <a class="material-icons help-button" href="#" title="Help">&#xE8FD;</a> -->
</div>

<!-- Pretty hacked together, maybe change this later -->
<form id="add-note" onsubmit="addNote(this.querySelector('#note-text').value); this.querySelector('#note-text').value = ''; this.style.display = 'none'; return false">
    <input id="note-text" class="medium-field" autocomplete="off" type="text" />
    <input class="medium-button" type="submit" value="Add Note" />
</form>

<div id="content">
    <datalist id="team-list"></datalist>

    <template id="add-team">
        <div class="team-info info-area">
            <input type="text" class="name medium-field" list="team-list" placeholder="Enter team name" /><br />
            <input type="text" class="odds medium-field" onkeypress="restrictOdds(this, event)" onfocus="this.value=''" onchange="completeOdds(this)" placeholder="Enter odds" />
            <button class="remove-item big-close material-icons" onclick="this.parentNode.parentNode.removeChild(this.parentNode);">&#xE5CD;</button>
        </div>
    </template>

    <template id="add-series">
        <div class="series-info info-area">
            <input type="text" class="date medium-field" onkeypress="restrictDate(this, event)" onfocus="this.value=''" placeholder="Date DDMMYYYY" /><br />
            <input type="text" class="time-utc medium-field" onkeypress="restrictTime(this, event)" onfocus="this.value=''" onchange="updateLocalTime(this.value, this.parentElement.querySelector('.time-local'))" placeholder="Time (UTC) HHMM" />
            <input type="text" class="time-local medium-field" onkeypress="restrictTime(this, event)" onfocus="this.value=''" onchange="updateUTC(this.value, this.parentElement.querySelector('.time-utc'), this.parentElement.querySelector('.date'))" placeholder="Time (local) HHMM" /><br />
            <label>Best of:</label>
            <input type="number" class="count medium-field" value="1" /><br />
            <input type="text" class="name1 medium-field" list="team-list" placeholder="First team name" />
            <input type="text" class="odds1 medium-field" onkeypress="restrictOdds(this, event)" onfocus="this.value=''" onchange="completeOdds(this)" placeholder="First team odds" /><br />
            <input type="text" class="name2 medium-field" list="team-list" placeholder="Second team name" />
            <input type="text" class="odds2 medium-field" onkeypress="restrictOdds(this, event)" onfocus="this.value=''" onchange="completeOdds(this)" placeholder="Second team odds" />
            <button class="remove-item big-close material-icons" onclick="this.parentNode.parentNode.removeChild(this.parentNode);">&#xE5CD;</button>
        </div>
    </template>

    <template id="note">
        <div class="info-area">
            <p></p>
            <button class="remove-item big-close material-icons" onclick="this.parentNode.parentNode.removeChild(this.parentNode);">&#xE5CD;</button>
        </div>
    </template>

    <div id="info">
        <div class="info-area">
            <select id="type-select" class="type-select medium-field" onchange="changeBetType()">
                <option disabled selected> -- Select bet type -- </option>
                <option value="h2h">Head to head</option>
                <option value="outright">Outright</option>
            </select>

            <input type="text" id="tournament-name" class="medium-field" placeholder="Enter tournament name" />
        </div>

        <div id="h2h" class="bet-type h2h">
            <div id="h2h-data"></div>
        </div>

        <div id="outright" class="bet-type outright">
            <div class="info-area">
                <input type="text" class="date medium-field" onkeypress="restrictDate(this, event)" onfocus="this.value=''" placeholder="Date DDMMYYYY" />
                <input type="text" class="time-utc medium-field" onkeypress="restrictTime(this, event)" onfocus="this.value=''" onchange="updateLocalTime(this.value, this.parentElement.querySelector('.time-local'))" placeholder="Time (UTC) HHMM" />
                <input type="text" class="time-local medium-field" onkeypress="restrictTime(this, event)" onfocus="this.value=''" onchange="updateUTC(this.value, this.parentElement.querySelector('.time-utc'), this.parentElement.querySelector('.date'))" placeholder="Time (local) HHMM" />
            </div>

            <div id="outright-data"></div>
        </div>
        <div id="notes"></div>
    </div>
    <script>
        function isNewTeam(name) {
            var o = document.getElementById('team-list').options;

            var i = o.length;
            while (i--) {
                console.log(o[i].value);

                if (o[i].value === name) {
                    return false;
                }
            }

            return true;
        }

        function getSelectedType() {
            var e = document.getElementById('type-select');
            return e.options[e.selectedIndex].value;
        }

        function compileOutright() {
            var div = document.getElementById('outright').querySelector('.info-area');
            var data = document.getElementById('outright-data').childNodes;
            var d = [];

            for (var i = 0; i < data.length; i++) {
                if (data[i].querySelector) {
                    console.log(data[i]);

                    var o = {
                        name: data[i].querySelector('.name').value,
                        odds: data[i].querySelector('.odds').value
                    };

                    if (!(isNewTeam(o.name) && !confirm('Include new team: ' + o.name + '?'))) {
                        d.push(o);
                    }
                }
            }

            return {
                tournament: document.getElementById('tournament-name').value,
                date: div.querySelector('.date').value,
                time: div.querySelector('.time-utc').value,
                data: d
            };
        }

        function compileH2H() {
            var data = document.getElementById('h2h-data').childNodes;

            var d = [];

            for (var i = 0; i < data.length; i++) {
                if (data[i].querySelector) {
                    var o = {
                        date: data[i].querySelector('.date').value,
                        time: data[i].querySelector('.time-utc').value,
                        series: data[i].querySelector('.count').value,
                        name1: data[i].querySelector('.name1').value,
                        odds1: data[i].querySelector('.odds1').value,
                        name2: data[i].querySelector('.name2').value,
                        odds2: data[i].querySelector('.odds2').value
                    };

                    if (!(isNewTeam(o.name1) && !confirm('Include new team: ' + o.name1 + '?'))
                            && !(isNewTeam(o.name2) && !confirm('Include new team: ' + o.name2 + '?'))) {
                        d.push(o);
                    }
                }
            }

            return {
                tournament: document.getElementById('tournament-name').value,
                data: d
            };
        }

        function createCSV(o) {
            var csv = 'TOURNAMENT,DATE,TIME UTC,TYPE,TEAM,ODDS';

            csv += "\n\n" + o.tournament;

            for (var i = 0; i < o.data.length; i++) {
                if (o.data[i].name) {
                    csv += ',,,Outright' + o.data[i].name;
                    csv += ',' + o.data[i].odds;
                } else if (o.data[i].name1) {
                    csv += ',,,H2H' + o.data[i].name1;
                    csv += ',' + o.data[i].odds1;
                    csv += '\n,,,' + o.data[i].name2;
                    csv += ',' + o.data[i].odds2;
                }

                csv += "\n\n"
            }

            return csv;
        }

        function createPDF(o) {
            var pdf = new jsPDF();

            pdf.setFontSize(15);
            pdf.setFontType('bold');

            pdf.text(20, 30, 'TOURNAMENT');
            pdf.text(65, 30, 'DATE');
            pdf.text(88, 30, 'TIME');
            pdf.text(105, 30, 'TYPE');
            pdf.text(130, 30, 'TEAM');
            pdf.text(165, 30, 'ODDS');

            pdf.setFontSize(10);
            pdf.text(90, 34, '(UTC)');

            pdf.setFontSize(12);
            pdf.setFontType('normal');

            var y = 40;

            var trm = o.tournament.split('-');

            for (var it = 0; it < trm.length; it++) {
                if (it == 0) {
                    pdf.text(20, y + it * 10, trm[it]);
                } else {
                    pdf.text(20, y + it * 10, "- " + trm[it]);
                }
            }

            if (o.date) {
                pdf.text(65, y, o.date);
                pdf.text(89, y, o.time);
            }

            for (var i = 0; i < o.data.length; i++) {
                if (o.data[i].name) {
                    pdf.text(105, y, 'Outright');
                    pdf.text(130, y, o.data[i].name);
                    pdf.text(165, y, o.data[i].odds);
                } else if (o.data[i].name1) {
                    pdf.text(65, y, o.data[i].date);
                    pdf.text(89, y, o.data[i].time);
                    pdf.text(105, y, 'H2H BO' + o.data[i].series);
                    pdf.text(130, y, o.data[i].name1);
                    pdf.text(165, y, o.data[i].odds1);
                    y += 10;
                    pdf.text(130, y, o.data[i].name2);
                    pdf.text(165, y, o.data[i].odds2);
                }

                y += 15;
            }

            pdf.save(o.tournament == "" ? "matches" : o.tournament);
        }

        function addTeam() {
            var content = document.querySelector('#add-team').content;
            document.querySelector('#outright-data').appendChild(document.importNode(content, true));
        }

        function addSeries() {
            var content = document.querySelector('#add-series').content;
            document.querySelector('#h2h-data').appendChild(document.importNode(content, true));
        }
    </script>
    <script>
        function generate() {
            var t = getSelectedType();
            var o = {};

            if (t == 'h2h') {
                o = compileH2H();
            } else if (t == 'outright') {
                o = compileOutright();
            }

            createPDF(o);
        }

        function changeBetType() {
            var t = document.querySelectorAll('.bet-type');

            var i = t.length;
            while (i--) {
                t[i].style.display = 'none';
            }

            document.getElementById(getSelectedType()).style.display = 'block';
        }

        function addItem() {
            var t = getSelectedType();

            if (t == 'h2h') {
                addSeries();
            } else if (t == 'outright') {
                addTeam();
            }
        }

        function toggleNoteContainer() {
            var an = document.getElementById('add-note');

            if (an.style.display == 'block') {
                an.style.display = 'none';
            } else {
                an.style.display = 'block';
            }
        }

        function addNote(text) {
            var content = document.importNode(document.getElementById('note').content, true);
            content.querySelector('p').innerText = text;
            document.getElementById('notes').appendChild(content);
        }

        function restrictOdds(field, e) {
            var evt = e || window.event;
            var key = evt.keyCode || evt.which;
            key = String.fromCharCode(key);

            var regex = /[0-9]|\./;

            if (!regex.test(key) || (key == '.' && field.value.indexOf('.') != -1) || (field.value.length > field.value.indexOf('.') + 2)) {
                evt.returnValue = false;
                evt.preventDefault();
            }
        }

        function completeOdds(field) {
            var i = field.value.indexOf('.');
            if (i == -1) {
                field.value += '.00';
            } else {
                var count = 2 - (field.value.length - i - 1);
                while (count--) {
                    field.value += '0';
                }
            }
        }

        function restrictTime(field, e) {
            var evt = e || window.event;
            var key = evt.keyCode || evt.which;
            key = String.fromCharCode(key);

            var regex = /[0-9]/;

            if (!regex.test(key) || field.value.length == 5) {
                evt.returnValue = false;
                evt.preventDefault();
            } else {
                if (field.value.length == 2) {
                    field.value += ':';
                }
            }
        }

        function restrictDate(field, e) {
            var evt = e || window.event;
            var key = evt.keyCode || evt.which;
            key = String.fromCharCode(key);

            var regex = /[0-9]/;

            if (!(regex.test(key)) || field.value.length == 10) {
                evt.returnValue = false;
                evt.preventDefault();
            } else {
                if (field.value.length == 2 || field.value.length == 5) {
                    field.value += '/';
                }
            }
        }

        function updateLocalTime(value, time) {
            var s = value.split(':');

            var h = s[0];
            var m = s[1];

            if (h && m && h <= 24 && m < 60) {
                h -= new Date().getTimezoneOffset() / 60;

                if (h > 24) {
                    h -= 24;
                } else if (h < 0) {
                    h += 24;
                }

                if (h / 10 < 1) {
                    h = "0" + h;
                }

                time.value = h + ':' + m;
            }
        }

        function updateUTC(value, time, date) {
            var s = value.split(':');

            var h = s[0];
            var m = s[1];

            if (h && m && h <= 24 && h > 0 && m < 60) {
                h = parseInt(h) + new Date().getTimezoneOffset() / 60;

                var dd = 0;

                if (h > 24) {
                    h -= 24;
                    dd = 1;
                } else if (h < 0) {
                    h += 24;
                    dd = -1;
                }

                if (h / 10 < 1) {
                    h = "0" + h;
                }

                time.value = h + ':' + m;

                if (date.value) {
                    var d = date.value.split('/');
                    date.value = "";

                    d[0] = parseInt(d[0]) + dd;

                    for (var i = 0, length = d.length; i < length; i++) {
                        if (i == 0) {
                            date.value += d[i];
                        } else {
                            date.value += "/" + d[i];
                        }
                    }
                }
            }
        }
    </script>
</div>
</body>
</html>